<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bani Overlay</title>
    <link rel="stylesheet" href="bundle.css" />
    <script src="socket.io.js"></script>

    <script>
      var previewData = {
        Gurmukhi: 'ik®pw kry jy AwpxI qw hir rKw aur Dwir ]1]',
        English: '',
        Punjabi: 'jy prmwqmw AwpxI myhr kry, qW mYN BI aus dw nwm ihrdy ivc pro r`KW [1[',
        Transliteration: 'kirapaa kare je aapanee taa har rakhaa aur dhaar ||1||',
        Spanish: 'Cuando el Señor así nos bendice, enaltecemos al Guru en la mente. (1)',
      };
      var socket = io();
      var preview = document.location.href.indexOf('preview') > -1;
      var overlayPrefs;
      function hexToRgb(hex) {
        if (hex === '#000') {
          return '0, 0, 0';
        }
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);

        return result
          ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}`
          : null;
      }
      var writeLine = function(Line, larivaar, languageSettings) {
        document.querySelector('.o-gurbani').innerHTML = larivaar
          ? Line.Gurmukhi.replace(/ /g, '')
          : Line.Gurmukhi || '';

        let translation = '';
        let transliteration = '';
        if (languageSettings) {
          translation = Line[languageSettings.translation] || '';
          transliteration = Line.Transliteration[languageSettings.transliteration] || '';
        } else {
          translation = Line.English || '';
          transliteration = Line.Transliteration || '';
        }

        document.querySelector('.o-translation').innerHTML = translation;
        document.querySelector('.o-teeka').innerHTML = Line.Punjabi || '';
        document.querySelector('.o-transliteration').innerHTML = transliteration;

        document.querySelector('.overlay-wrapper').hidden =
          Line.Gurmukhi === '' && Line.English === '';
      };

      var applyOverlayPrefs = function() {
        document.querySelectorAll('.content-top, .content-bottom').forEach(el => {
          el.style.color = overlayPrefs.overlayVars.textColor;
          el.style.fontSize = `${overlayPrefs.overlayVars.fontSize}vh`;
          el.style.backgroundColor = `rgba(${hexToRgb(overlayPrefs.overlayVars.bgColor)}, ${
            overlayPrefs.overlayVars.bgOpacity
          })`;
        });

        document.querySelector('.logo-wrapper').style.opacity = overlayPrefs.overlayVars.bgOpacity;
        document.querySelector(
          '.o-gurbani',
        ).style.fontSize = `${overlayPrefs.overlayVars.gurbaniFontSize}vh`;
        document.querySelector('.o-gurbani').style.color =
          overlayPrefs.overlayVars.gurbaniTextColor;

        document.body.classList.remove(
          'layout-top',
          'layout-bottom',
          'layout-split',
          'layout-classic',
          'layout-vertical',
          'layout-vertical-left',
        );

        document.body.classList.add('layout-' + overlayPrefs.overlayVars.layout);

        document.body.classList.toggle('logo-off', !overlayPrefs.overlayVars.overlayLogo);

        /* const overrideTheme = function(selector) {
          const $layoutBody = document.querySelector(selector);
          if ($layoutBody) {
            $layoutBody
              .querySelectorAll('.content-top, .content-bottom, .content-bar')
              .forEach(el => {
                el.style.backgroundColor = 'transparent';
                el.style.color = '#fff';
                document.querySelector('.o-gurbani').style.color = '#fff';
              });
          }
        };

        overrideTheme('.layout-classic');
        overrideTheme('.layout-vertical');
        overrideTheme('.layout-vertical-left');*/

        document.querySelectorAll('.content-top, .content-bottom').forEach(el => {
          document.querySelector('span.o-gurbani').style.backgroundColor = `transparent`;
          document.querySelector('span.o-translation').style.backgroundColor = `transparent`;
          el.style.backgroundColor = `rgba(${hexToRgb(overlayPrefs.overlayVars.bgColor)}, ${
            overlayPrefs.overlayVars.bgOpacity
          })`;
          document.querySelector('.overlay-wrapper').style.backgroundColor = 'transparent';
        });

        document
          .querySelectorAll(
            '.layout-vertical .overlay-wrapper, .layout-vertical-left .overlay-wrapper',
          )
          .forEach(el => {
            document.querySelectorAll('.content-top, .content-bottom').forEach(content => {
              content.style.backgroundColor = 'transparent';
            });
            el.style.backgroundColor = `rgba(${hexToRgb(overlayPrefs.overlayVars.bgColor)}, ${
              overlayPrefs.overlayVars.bgOpacity
            })`;
          });

        document
          .querySelectorAll('.layout-classic .content-top, .layout-classic .content-bottom')
          .forEach(el => {
            el.style.backgroundColor = 'transparent';
            document.querySelector('span.o-gurbani').style.backgroundColor = `rgba(${hexToRgb(
              overlayPrefs.overlayVars.bgColor,
            )}, ${overlayPrefs.overlayVars.bgOpacity})`;
            document.querySelector('span.o-translation').style.backgroundColor = `rgba(${hexToRgb(
              overlayPrefs.overlayVars.bgColor,
            )}, ${overlayPrefs.overlayVars.bgOpacity})`;
            document.querySelector('.overlay-wrapper').style.backgroundColor = 'transparent';
          });

        const $gurbani = document.querySelector('.o-gurbani');
        if (overlayPrefs.overlayVars.overlayLarivaar) {
          $gurbani.innerHTML = $gurbani.innerHTML.replace(/ /g, '<wbr>');
        } else {
          $gurbani.innerHTML = $gurbani.innerHTML.replace(/<wbr>/g, ' ');
        }
      };

      socket.on('show-line', function(request) {
        if (!preview) {
          overlayPrefs = request.overlayPrefs;
          writeLine(request.Line, overlayPrefs.overlayVars.larivaar, request.languageSettings);
        }
      });

      socket.on('update-prefs', function(request) {
        overlayPrefs = request.overlayPrefs;
        applyOverlayPrefs();
      });
    </script>
  </head>
  <body class="layout-bottom bani-overlay-page">
    <section class="overlay-wrapper">
      <div class="content-top">
        <div class="content-bar "><span class="gurmukhi o-gurbani"> </span></div>
        <div class="content-bar"><span class=" o-teeka"> </span></div>
      </div>
      <div class="content-bars-bottom">
        <div class="content-bottom">
          <div class="content-bar"><span class="o-transliteration"> </span></div>
          <div class="content-bar"><span class="o-translation"> </span></div>
        </div>
        <div class="logo-wrapper">
          <img alt="SikhiToTheMax" src="./sikhi-max-logo.png" class="sttm-logo" />
          <img alt="SikhiToTheMax" src="./sikhi-max-logo-white.png" class="sttm-logo-white" />
        </div>
      </div>
    </section>
    <script type="text/javascript">
      if (preview) {
        writeLine(previewData);
      }
    </script>
  </body>
</html>
